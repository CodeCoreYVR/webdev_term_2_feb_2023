## Mailer

* Install `letter-opener` gem in development and test group
```
gem 'letter_opener', '~> 1.4', '>= 1.4.1'
```

* Rails comes with ActionMailer that enables us to send mails from the application with controllers and view.
Check https://guides.rubyonrails.org/action_mailer_basics.html for more information. 

* Create a file `/config/initializers/setup_mail.rb`. The setting format comes from ActionMailer gem.
```ruby
ActionMailer::Base.smtp_settings = {
    address:              "smtp.gmail.com",
    port:                 "587",
    enable_starttls_auto: true,
    authentication:       :plain,
    user_name:            ENV["email_user_name"],
    password:             ENV["email_password"]
  }
```

* Create a file `/config/initializers/app_keys.rb` for the environment variables, and add it to .gitignore
```ruby
#app_keys.rb
ENV["email_user_name"] = "yourusername"
ENV["email_password"]  = "supersecret"
```
```
#.gitignore
/**/config/initializers/app_keys.rb
```

* Create an sample file `/config/initializers/app_keys.rb.example` to save the environment variable names so that other app_keys.rb files can be created easily when deploying in production or test environment.


* Run the following command to generate a mailer for answer. We want to send email to the questioner when someone answers the question.
```
rails g mailer answers_mailer
```
After running the command a directory `app/mailer` will be created where the controller and view remains for sending email.

* Created files:
```
create  app/mailers/answers_mailer.rb
      invoke  erb
      create    app/views/answers_mailer
      invoke  rspec
      create    spec/mailers/answers_mailer_spec.rb
      create    spec/mailers/previews/answers_mailer_preview.rb
```

* HTML vs Text in email. Check https://webmasters.stackexchange.com/questions/21367/plain-text-email-support-is-it-still-needed-in-2011

* Define Email method
```ruby
class AnswersMailer < ApplicationMailer

  def notify_questioner(answer)
    @answer   = answer
    @question = answer.question
    @owner    = @question.user
    mail(to: @owner.email, subject: "You got a new answer!")
  end

end
```

* Add the following line in `config/environments/development.rb` so that the email saved to temp directory instead of sending for development environment.
```ruby
    config.action_mailer.delivery_method = :letter_opener
    config.action_mailer.perform_deliveries = true
```

* The default mailing url needs to be added in `config/environments/development.rb`. For production it will be different. In production, consider using a dedicated mailing service instead of google.
```ruby
  config.action_mailer.default_url_options = {host: 'localhost', port: 3000}
```

* Call the method from answers_controller#create to send the email after saving the anser in db.
```ruby
#answers_controller.rb
#... after save in create action
AnswersMailer.notify_questioner(@answer).deliver_now 
#...
```

* Answer a question and the content of sent email  will be saved in `/tmp/letter_opener/`

* We can also use `AnswersMailer.notify_questioner(@answer).deliver_later` to send the email in the background jobs. We need to set up `ActiveJob` with background processing system such as `delayedJob`.

## Background Job

* In web applications, some of the tasks don't need to be run immediately, and some of them take significant amount of time to complete. Those tasks are run in seperate thread asynchronously. Rails introduced `ActiveJob`to create task that can be run later. ActiveJob needs another system to take the task defined by it and run it later. One of such system is `DelayedJob`
```
gem 'delayed_job_active_record'
```

* The delayed jobs are stored in database. So we need to generate delayed job and migrate in db
```
rails g delayed_job:active_record
```
```
rails db:migrate
```

* We need to set the queue adapter as delayed_job in `config/application.rb` for active_job
```ruby
#config/application.rb
config.active_job.queue_adapter = :delayed_job
```

* To run the queued delayed job
```
rails jobs:work
``` 

* Create a ActiveJob
```
rails g job most_liked_last_month
```

* The `most_liked_last_month_job.rb` file will be created in `app\jobs` directory. Modify the code to get most liked questions from last month.
```ruby
class MostLikedLastMonthJob < ApplicationJob
  queue_as :default

  def perform(*args)
    def perform(*args)
      @questions = Question.select("questions.id, count(questions.id) AS count").
                           joins(:likes).
                           group("questions.id").
                           order("count DESC").
                           where("questions.created_at >= ? AND questions.created_at <= ?",
                                  Time.now.last_month.beginning_of_month,
                                  Time.now.last_month.end_of_month).
                           limit(10)
      QuestionsMailer.send_monthly_report(@questions).deliver_now
    end
  end
end

```

* Here, we will need a new mailer named `QuestionsMailer` to send the mail
```ruby
class QuestionsMailer < ApplicationMailer

    def send_monthly_report(questions)
      @question = questions
      @admin    = "admin@email.com"
      mail(to: @admin, subject: "Most liked questions of last month")
    end
  
end
```

* Add and modify the view for QuestionsMailer > send_monthly_report

* Open rails console in a different terminal, run job:work in another terminal and run rails s in another.

* From rails console run the following:
```
MostLikedLastMonthJob.perform_now
```
or we can also perform it later,
```
MostLikedLastMonthJob.set(wait: 1.month).perform_later
```

* If we want to run jobs from Rails console then we want be sure they're loaded in the Rails console. Adding a line to you /app/config/application.rb can be helpful.
```
config.autoload_paths  << Rails.root.join("app", "jobs")
```

* Rails ActionMailer can automatically queue an email to be sent by using deliver_later so you don't have to create a separate job for that

* Run the following command to remove all the queued jobs
```
rake jobs:clear
```

* For more information,check the https://github.com/collectiveidea/delayed_job